#!/usr/bin/env bash

set -e

rm -fr npm
mkdir npm

(
  set -x

  cp Changes npm

  find lib | grep -E '\.coffee$' | while read -r file; do
    if [[ $file == 'lib/index.coffee' ]]; then
      js="npm/index.js"
    else
      js="npm/${file/\.coffee/.js}"
    fi
    mkdir -p "$(dirname "$js")"
    coffee --print --compile "$file" > "$js"
  done

  if [[ -d bin ]]; then
    find bin -type f | while read -r file; do
      js="npm/$file"
      mkdir -p "$(dirname "$js")"

      if head -n1 "$file" | grep -q coffee; then
        echo "#!/usr/bin/env node" > "$js"
        coffee --print --compile "$file" >> "$js"
      else
        cp "$file" "$js"
      fi

      chmod +x "$js"
    done
  fi

  for x in .rc eg; do
    [[ -e $x ]] && cp -r "$x" npm/
  done

  cp -r test npm/

  ingy-npm-make-package-json > npm/package.json
)

find doc -type f -name '*.swim' | while read -r swim; do
  md="${swim/.swim/.md}"
  md="npm/$md"
  mkdir -p "$(dirname "$md")"
  if grep '^====' "$swim" &> /dev/null; then
    (
      set -x
      swim --to=md --complete --wrap "$swim" > "$md"
      swim --to=md --complete --wrap "$swim" > npm/ReadMe.md
    )
  else
    (
      set -x
      swim --to=md --complete --wrap "$swim" > "$md"
    )
  fi
done

# vim: set sw=2 lisp:
